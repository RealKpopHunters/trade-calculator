<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화폐 거래소 거래 계산기</title>
    <style>
        /* CSS는 이전과 동일하게 유지됩니다. */
        :root {
            --bg-color: #2D2D2D; --fg-color: #E0E0E0; --accent-color: #4ECDC4;
            --secondary-color: #555555; --entry-bg: #3A3A3A; --border-color: #444444;
            --title-font: "Malgun Gothic", "Segoe UI", sans-serif; --body-font: "Malgun Gothic", "Segoe UI", sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color); color: var(--fg-color); font-family: var(--body-font);
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 2rem 1rem;
        }
        .container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 1.5rem; }
        .card {
            background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .card-title {
            font-family: var(--title-font); font-size: 1.25rem; font-weight: bold; color: var(--accent-color);
            margin-bottom: 1.5rem; border-left: 4px solid var(--accent-color); padding-left: 0.75rem;
        }
        .form-group {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;
        }
        .form-group label { font-size: 1rem; min-width: 100px; }
        input[type="number"], select {
            background-color: var(--entry-bg); color: var(--fg-color); border: 1px solid var(--border-color);
            border-radius: 5px; padding: 0.75rem; font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s; flex-grow: 1;
        }
        input[type="checkbox"] { width: 1.1rem; height: 1.1rem; accent-color: var(--accent-color); }
        input[type="number"]:focus, select:focus {
            outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.3);
        }
        .ratio-inputs { display: flex; align-items: center; gap: 0.5rem; flex-grow: 1; }
        .ratio-inputs select { flex-grow: 2; }
        .ratio-inputs input { flex-grow: 1; }
        .ratio-separator { font-size: 1.5rem; color: var(--fg-color); }
        .strategy-options, .advanced-options { display: flex; flex-direction: column; gap: 1rem; }
        .options-grid { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .radio-group { display: flex; align-items: center; gap: 0.5rem; }
        .custom-discount-group { display: flex; align-items: center; gap: 0.5rem; }
        #custom-discount-entry { width: 70px; }
        .option-description { font-size: 0.85rem; color: var(--secondary-color); padding-left: 1.6rem; margin-top: -0.5rem; }
        .result-container {
            display: flex; justify-content: space-around; align-items: center; gap: 1rem;
            margin-top: 1rem; flex-wrap: wrap;
        }
        .result-box {
            background-color: var(--entry-bg); padding: 1rem; border-radius: 8px; text-align: center;
            flex: 1; min-width: 200px;
        }
        .result-label { font-size: 1rem; color: var(--fg-color); margin-bottom: 0.5rem; }
        .result-value-wrapper { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .result-value { font-size: 2rem; font-weight: bold; color: var(--accent-color); min-height: 48px; }
        .copy-btn {
            background-color: var(--secondary-color); color: var(--fg-color); border: none; border-radius: 5px;
            padding: 0.5rem 0.75rem; font-size: 0.9rem; cursor: pointer; transition: background-color 0.3s;
        }
        .copy-btn:hover:not(:disabled) { background-color: var(--accent-color); color: var(--bg-color); }
        .copy-btn:disabled { background-color: #444; cursor: not-allowed; }
        .result-separator { font-size: 2.5rem; font-weight: bold; color: var(--secondary-color); }
        .final-ratio-display {
            text-align: center; margin-top: 1.5rem; font-size: 1.2rem;
            font-style: italic; color: var(--accent-color); min-height: 2rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Input Section -->
        <div class="card">
            <h2 class="card-title">시세 입력</h2>
            <div class="form-group">
                <label for="currency-combobox">현재 시세:</label>
                <div class="ratio-inputs">
                    <select id="currency-combobox">
                        <option value="카오스 오브">카오스 오브</option>
                        <option value="디바인 오브">디바인 오브</option>
                    </select>
                    <input type="number" id="market-currency-qty" value="280" min="1">
                    <span class="ratio-separator">:</span>
                    <input type="number" id="market-item-qty" value="1" min="1">
                    <span>개</span>
                </div>
            </div>
            <div class="form-group">
                <label for="my-item-qty">보유 수량:</label>
                <input type="number" id="my-item-qty" value="3000" min="1">
            </div>
        </div>

        <!-- Pricing Strategy Section -->
        <div class="card">
            <h2 class="card-title">가격 책정 전략</h2>
            <div class="strategy-options">
                <div class="options-grid">
                    <div class="radio-group"><input type="radio" id="discount0" name="discount" value="0" checked><label for="discount0">표준 (0%)</label></div>
                    <div class="radio-group"><input type="radio" id="discount1" name="discount" value="1"><label for="discount1">1% 할인</label></div>
                    <div class="radio-group"><input type="radio" id="discount5" name="discount" value="5"><label for="discount5">5% 할인</label></div>
                    <div class="radio-group"><input type="radio" id="discount10" name="discount" value="10"><label for="discount10">10% 할인</label></div>
                    <div class="radio-group custom-discount-group">
                        <input type="radio" id="discountCustom" name="discount" value="-1"><label for="discountCustom">직접 입력:</label>
                        <input type="number" id="custom-discount-entry" min="0" disabled><span>%</span>
                    </div>
                </div>
            </div>

            <div class="advanced-options" style="margin-top: 1.5rem;">
                 <div class="radio-group">
                    <input type="checkbox" id="clean-ratio-checkbox" checked>
                    <label for="clean-ratio-checkbox">교환비를 소수점 2자리로 맞춤</label>
                 </div>
                 <div class="option-description">거래 비율이 1:2.85 처럼 깔끔하게 끝나도록 판매 수량을 자동으로 보정합니다.</div>
                 <div class="radio-group" style="margin-top: 1rem;">
                    <input type="checkbox" id="round-to-ten-checkbox" checked>
                    <label for="round-to-ten-checkbox">판매 수량을 10개 단위로 올림</label>
                 </div>
                 <div class="option-description">거래 제안을 10, 20, 30개 등 10의 배수로 맞춥니다.</div>
            </div>
        </div>

        <!-- Result Section -->
        <div class="card">
            <h2 class="card-title">최적 거래 제안</h2>
            <div class="result-container">
                <div class="result-box">
                    <div id="result-currency-label" class="result-label">카오스 오브</div>
                    <div class="result-value-wrapper">
                        <div id="result-currency-qty" class="result-value"></div>
                        <button id="copy-currency-btn" class="copy-btn" disabled>복사</button>
                    </div>
                </div>
                <div class="result-separator">:</div>
                <div class="result-box">
                    <div class="result-label">판매 아이템</div>
                    <div class="result-value-wrapper">
                        <div id="result-item-qty" class="result-value"></div>
                        <button id="copy-items-btn" class="copy-btn" disabled>복사</button>
                    </div>
                </div>
            </div>
            <div class="final-ratio-display" id="final-ratio"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const marketCurrencyQtyEl = document.getElementById('market-currency-qty');
            const marketItemQtyEl = document.getElementById('market-item-qty');
            const myItemQtyEl = document.getElementById('my-item-qty');
            const currencyCombobox = document.getElementById('currency-combobox');
            const customDiscountEntryEl = document.getElementById('custom-discount-entry');
            const discountRadios = document.querySelectorAll('input[name="discount"]');
            const resultCurrencyLabelEl = document.getElementById('result-currency-label');
            const resultCurrencyQtyEl = document.getElementById('result-currency-qty');
            const resultItemQtyEl = document.getElementById('result-item-qty');
            const finalRatioEl = document.getElementById('final-ratio');
            const copyCurrencyBtn = document.getElementById('copy-currency-btn');
            const copyItemsBtn = document.getElementById('copy-items-btn');
            const roundToTenCheckbox = document.getElementById('round-to-ten-checkbox');
            const cleanRatioCheckbox = document.getElementById('clean-ratio-checkbox');

            function updateCalculation() {
                try {
                    const marketCurrency = parseFloat(marketCurrencyQtyEl.value);
                    const marketItem = parseFloat(marketItemQtyEl.value);
                    const myItemQuantity = parseInt(myItemQtyEl.value, 10);
                    let discountPercentage = parseFloat(document.querySelector('input[name="discount"]:checked').value);
                    if (discountPercentage === -1) {
                        discountPercentage = parseFloat(customDiscountEntryEl.value) || 0;
                    }

                    if (isNaN(marketCurrency) || isNaN(marketItem) || isNaN(myItemQuantity) || marketCurrency <= 0 || marketItem <= 0 || myItemQuantity <= 0) {
                        clearResults();
                        return;
                    }

                    const baseRate = marketItem / marketCurrency;
                    const discountedRate = baseRate * (1 + discountPercentage / 100.0);
                    let bestTrade = null;
                    let bestTradeValue = 0;

                    if (discountedRate > 0) {
                        const maxCurrencyToCheck = Math.floor(myItemQuantity / discountedRate) + 5;
                        for (let currencyToReceive = 1; currencyToReceive < maxCurrencyToCheck; currencyToReceive++) {
                            let itemsToSell = Math.floor(currencyToReceive * discountedRate);
                            if (roundToTenCheckbox.checked) {
                                itemsToSell = Math.ceil(itemsToSell / 10) * 10;
                            }
                            if (cleanRatioCheckbox.checked) {
                                const increment = roundToTenCheckbox.checked ? 10 : 1;
                                while ((itemsToSell * 100) % currencyToReceive !== 0 && itemsToSell < myItemQuantity) {
                                    itemsToSell += increment;
                                }
                            }
                            if (itemsToSell > 0 && itemsToSell <= myItemQuantity) {
                                const tradeValue = currencyToReceive;
                                if (tradeValue > bestTradeValue) {
                                    bestTrade = { currency: currencyToReceive, items: itemsToSell };
                                    bestTradeValue = tradeValue;
                                }
                            }
                        }
                    }

                    if (bestTrade) {
                        resultCurrencyQtyEl.textContent = bestTrade.currency;
                        resultItemQtyEl.textContent = bestTrade.items;
                        resultCurrencyLabelEl.textContent = currencyCombobox.value === '카오스 오브' ? '디바인 오브' : '카오스 오브';
                        resultCurrencyLabelEl.textContent = currencyCombobox.value;


                        // ★★★ [수정] 최종 교환비 표시 로직 ★★★
                        let finalRatioStr;
                        const actualRate = bestTrade.items / bestTrade.currency;

                        if (actualRate >= 1) {
                            // 비율이 1보다 크거나 같으면 "1 : X" 형식
                            finalRatioStr = `1 : ${actualRate.toFixed(2)}`;
                        } else {
                            // 비율이 1보다 작으면 "X : 1" 형식으로 변환
                            const inverseRate = bestTrade.currency / bestTrade.items;
                            finalRatioStr = `${inverseRate.toFixed(2)} : 1`;
                        }
                        finalRatioEl.textContent = `최종 교환비: ${finalRatioStr}`;
                        // ★★★ 수정 끝 ★★★

                        copyCurrencyBtn.disabled = false;
                        copyItemsBtn.disabled = false;
                    } else {
                        clearResults();
                    }
                } catch (error) {
                    console.error("계산 오류:", error);
                    clearResults();
                }
            }

            function clearResults() {
                resultCurrencyQtyEl.textContent = "";
                resultItemQtyEl.textContent = "";
                finalRatioEl.textContent = "";
                resultCurrencyLabelEl.textContent = currencyCombobox.value;
                copyCurrencyBtn.disabled = true;
                copyItemsBtn.disabled = true;
            }

            function handleDiscountChange() {
                const selectedValue = document.querySelector('input[name="discount"]:checked').value;
                customDiscountEntryEl.disabled = selectedValue !== '-1';
                if (selectedValue === '-1') customDiscountEntryEl.focus();
                else customDiscountEntryEl.value = '';
                updateCalculation();
            }

            async function copyToClipboard(text, button) {
                if (!text) return;
                try {
                    await navigator.clipboard.writeText(text);
                    const originalText = button.textContent;
                    button.textContent = '복사 완료!';
                    setTimeout(() => { button.textContent = originalText; }, 1500);
                } catch (err) {
                    console.error('복사에 실패했습니다: ', err);
                }
            }

            const allInputs = [marketCurrencyQtyEl, marketItemQtyEl, myItemQtyEl, currencyCombobox, customDiscountEntryEl, roundToTenCheckbox, cleanRatioCheckbox];
            allInputs.forEach(el => {
                el.addEventListener('input', updateCalculation);
                el.addEventListener('change', updateCalculation);
            });
            discountRadios.forEach(radio => radio.addEventListener('change', handleDiscountChange));
            copyCurrencyBtn.addEventListener('click', () => copyToClipboard(resultCurrencyQtyEl.textContent, copyCurrencyBtn));
            copyItemsBtn.addEventListener('click', () => copyToClipboard(resultItemQtyEl.textContent, copyItemsBtn));
            
            updateCalculation();
        });
    </script>
</body>

</html>
